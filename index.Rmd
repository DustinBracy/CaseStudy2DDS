---
title: "Employee Attrition EDA for DDSAnalytics"
author: "Dustin Bracy"
date: "12/05/2019"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)
library(corrplot)
library(class)
library(caret)
library(olsrr)
```

## R Markdown

Objectives:  
- Identify the top three factors that contribute to employee attrition (backed up by evidence provided by analysis).
- Identify job and/or role specific trends.
- Identify useful factors related to talent management (workforce planning, employee training, identifying high potential employees, reducing turnover)
- Present findings via YouTube in 7 minutes or less

Target Audience:
- CEO and CFO of Frito Lay
- CEO is statistician, CFO has had only one class in statistics

Clarification:
- Job level 1-5 low-high
- Overtime = non-exempt
- Distance is unknown (mi/km), suggest using high/low
- use percent attrition vs count
- performance ratings maybe indicate there is a fear of giving a low score
- training times last year = # of traning sessions attended
- what is hourly/daily/monthly rate?  Production rates?  

```{r import/tidy}
data <- read.csv('./data/CaseStudy2-data.csv', header=T)
oData <- data

# Check for missing values:
MissingValues <- sapply(data, function(x)sum(is.na(x)))
MissingValues %>% kable("html") %>% kable_styling()


# One-hot encode variables:
data$Attrition <- ifelse(data$Attrition == "Yes",1,0)
data$OverTime <- ifelse(data$OverTime == "Yes",1,0)
data$Gender <- ifelse(data$Gender == "Male",1,0)
busTrav <- c("Non-Travel","Travel_Rarely", "Travel_Frequently")
data$BusinessTravel <- as.numeric(factor(data$BusinessTravel, levels=busTrav)) -1
data$HumanResources <- ifelse(data$Department == "Human Resources",1,0)
data$ResearchDevelopment <- ifelse(data$Department == "Research & Development",1,0)
data$Sales <- ifelse(data$Department == "Sales",1,0)
data$Single <- ifelse(data$MaritalStatus == "Single",1,0)
data$Married <- ifelse(data$MaritalStatus == "Married",1,0)
data$Divorced <- ifelse(data$MaritalStatus == "Divorced",1,0)
data$EdHumanResources <- ifelse(data$EducationField == "Human Resources",1,0)
data$EdLifeSciences <- ifelse(data$EducationField == "Life Sciences",1,0)
data$EdMedical <- ifelse(data$EducationField == "Medical",1,0)
data$EdMarketing <- ifelse(data$EducationField == "Marketing",1,0)
data$EdTechnicalDegree <- ifelse(data$EducationField == "Technical Degree",1,0)
data$EdOther <- ifelse(data$EducationField == "Other",1,0)
data$JobSalesExecutive <- ifelse(data$JobRole == "Sales Executive",1,0)
data$JobResearchDirector <- ifelse(data$JobRole == "Research Director",1,0)
data$JobManufacturingDirector <- ifelse(data$JobRole == "Manufacturing Director",1,0)
data$JobResearchScientist <- ifelse(data$JobRole == "Research Scientist",1,0)
data$JobSalesExecutive <- ifelse(data$JobRole == "Sales Executive",1,0)
data$JobSalesRepresentative <- ifelse(data$JobRole == "Sales Representative",1,0)
data$JobManager <- ifelse(data$JobRole == "Manager",1,0)
data$JobHealthcareRepresentative <- ifelse(data$JobRole == "Healthcare Representative",1,0)
data$JobHumanResources <- ifelse(data$JobRole == "Human Resources",1,0)
data$JobLaboratoryTechnician <- ifelse(data$JobRole == "Laboratory Technician",1,0)

# drop factors
data <- subset(data, select = -c(Over18, Department, JobRole, MaritalStatus, EducationField, EmployeeCount, StandardHours))

```

```{r visualize}
data %>% group_by(Attrition) %>% summarise(Employees = n()) %>% ggplot(mapping=aes(Attrition, Employees)) + geom_col()



data %>% ggplot(aes(JobLevel, Attrition)) + geom_smooth()
data %>% ggplot(aes(BusinessTravel, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsInCurrentRole, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsAtCompany, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsSinceLastPromotion, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsWithCurrManager, Attrition)) + geom_smooth()
data %>% ggplot(aes(TotalWorkingYears, Attrition)) + geom_smooth()
data %>% ggplot(aes(MonthlyIncome, Attrition)) + geom_smooth()
data %>% ggplot(aes(MonthlyRate, Attrition)) + geom_smooth()
data %>% ggplot(aes(NumCompaniesWorked, Attrition)) + geom_col(width=1)
data %>% ggplot(aes(JobLevel, Attrition)) + geom_smooth()
data %>% ggplot(aes(JobSatisfaction, Attrition)) + geom_smooth()
data %>% ggplot(aes(RelationshipSatisfaction, Attrition)) + geom_smooth()
data %>% ggplot(aes(DistanceFromHome, Attrition)) + geom_smooth()
data %>% ggplot(aes(DailyRate, Attrition)) + geom_smooth()

data %>% ggplot(aes(JobResearchDirector, Attrition)) + geom_col()
data %>% ggplot(aes(JobSalesExecutive, Attrition)) + geom_col()
data %>% ggplot(aes(JobManufacturingDirector, Attrition)) + geom_col()
data %>% ggplot(aes(JobResearchScientist, Attrition)) + geom_col()
data %>% ggplot(aes(JobHumanResources, Attrition)) + geom_col()
data %>% ggplot(aes(JobHealthcareRepresentative, Attrition)) + geom_col()
data %>% ggplot(aes(JobManager, Attrition)) + geom_col()
data %>% ggplot(aes(JobSalesRepresentative, Attrition)) + geom_col()
data %>% ggplot(aes(JobLaboratoryTechnician, Attrition)) + geom_col()

data %>% ggplot(aes(EdHumanResources, Attrition)) + geom_col()
data %>% ggplot(aes(EdMedical, Attrition)) + geom_col()
data %>% ggplot(aes(EdMarketing, Attrition)) + geom_col()
data %>% ggplot(aes(EdTechnicalDegree, Attrition)) + geom_col()
data %>% ggplot(aes(EdOther, Attrition)) + geom_col()
data %>% ggplot(aes(EdLifeSciences, Attrition)) + geom_col()

data.cor <- cor(data)
data.cor %>% kable("html") %>% kable_styling

# mat : is a matrix of data
# ... : further arguments to pass to the native R cor.test function
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(data)

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
png(height=1200, width=1500, pointsize=8, file="corrNums.png")
corrplot(data.cor, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.01, insig = "blank", tl.cex = 1.25,
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )
ggsave("corrNums.png", units="in", width=5, height=4, dpi=600)
dev.off()

png(height=1200, width=1800, pointsize=15, file="overlap.png")
corrplot(data.cor, method='circle', order="hclust",tl.col="black", type='upper', tl.cex = 1, p.mat = p.mat, sig.level = 0.01, insig = 'blank')
ggsave("corrHalf.png", units="in", width=5, height=4, dpi=600)
dev.off()
```


# KNN Prediction
```{r model attrition}
set.seed(113)
splitPerc = .7
iterations = 10
numks =5
masterAcc = matrix(nrow = iterations, ncol = numks)

for(j in 1:iterations) {
  
  accs = data.frame(accuracy = numeric(numks), k = numeric(numks))
  trainIndices = sample(1:dim(data)[1],round(splitPerc * dim(data)[1]))
  train = data[trainIndices,]
  test = data[-trainIndices,]
  
  for(i in 1:numks) {
    
    classifications = knn(train[,c('BusinessTravel','JobSatisfaction')],test[,c('BusinessTravel','JobSatisfaction')],as.factor(train$Attrition), prob = TRUE, k = i)
    
    table(as.factor(test$Attrition),classifications)
    CM = confusionMatrix(table(as.factor(test$Attrition),classifications))
    masterAcc[j,i] = CM$overall[1]
  }
}

MeanAcc = colMeans(masterAcc)
plot(seq(1,numks,1),MeanAcc, Attrition = 1)
k <- which.max(MeanAcc)

classifications = knn(train[,c('BusinessTravel','JobSatisfaction')],test[,c('BusinessTravel','JobSatisfaction')],train$Attrition, prob = TRUE, k)

table(test$Attrition,classifications)

confusionMatrix(table(test$Attrition,classifications))

knn(train[,c('BusinessTravel')], test[,c('BusinessTravel')], train$Attrition, prob=T, k=3)


    classifications = knn(train[,c('BusinessTravel','JobSatisfaction')],test[,c('BusinessTravel','JobSatisfaction')],as.factor(train$Attrition), prob = TRUE, k = 1)
    
    table(as.factor(test$Attrition),classifications)
    CM = confusionMatrix(table(as.factor(test$Attrition),classifications))
    masterAcc[1,1] = CM$overall[1]
    classifications
```



```{r model salary}
set.seed(113)
splitPerc = .7
train$LogMonthlyIncome <- log(train$MonthlyIncome)
  trainIndices = sample(1:dim(data)[1],round(splitPerc * dim(data)[1]))
  train = data[trainIndices,]
  test = data[-trainIndices,]
salFit <- lm(MonthlyIncome ~ JobLevel + TotalWorkingYears
             + JobManager + JobResearchDirector + JobLaboratoryTechnician 
             , data=train)
summary(salFit)

salPrd <- predict(salFit, interval='predict',newdata = test)
RMSE <- sqrt(mean((salPrd[,1] - test$MonthlyIncome)^2))
RMSE

olsrr::ols_plot_diagnostics(salFit)

```
