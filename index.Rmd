---
title: "Employee Attrition EDA for DDSAnalytics"
author: "Dustin Bracy"
date: "12/05/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)
library(corrplot)
library(class)
library(caret) #knn
library(olsrr)
library(e1071) #naive bayes
library(fastNaiveBayes)
library(GGally)
```

## R Markdown

Objectives:  
- Identify the top three factors that contribute to employee attrition (backed up by evidence provided by analysis).
- Identify job and/or role specific trends.
- Identify useful factors related to talent management (workforce planning, employee training, identifying high potential employees, reducing turnover)
- Present findings via YouTube in 7 minutes or less

Target Audience:
- CEO and CFO of Frito Lay
- CEO is statistician, CFO has had only one class in statistics

Clarification:
- Job level 1-5 low-high
- Overtime = non-exempt
- Distance is unknown (mi/km), suggest using high/low
- use percent attrition vs count
- performance ratings maybe indicate there is a fear of giving a low score
- training times last year = # of traning sessions attended
- what is hourly/daily/monthly rate?  Production rates?  

```{r import/tidy}
data <- read.csv('./data/CaseStudy2-data.csv', header=T)
oData <- data

# Check for missing values:
MissingValues <- sapply(data, function(x)sum(is.na(x)))
MissingValues %>% kable("html") %>% kable_styling()


# One-hot encode variables:
data$Attrition <- ifelse(data$Attrition == "Yes",1,0)
data$OverTime <- ifelse(data$OverTime == "Yes",1,0)
data$Gender <- ifelse(data$Gender == "Male",1,0)
busTrav <- c("Non-Travel","Travel_Rarely", "Travel_Frequently")
data$BusinessTravel <- as.numeric(factor(data$BusinessTravel, levels=busTrav)) -1
data$HumanResources <- ifelse(data$Department == "Human Resources",1,0)
data$ResearchDevelopment <- ifelse(data$Department == "Research & Development",1,0)
data$Sales <- ifelse(data$Department == "Sales",1,0)
data$Single <- ifelse(data$MaritalStatus == "Single",1,0)
data$Married <- ifelse(data$MaritalStatus == "Married",1,0)
data$Divorced <- ifelse(data$MaritalStatus == "Divorced",1,0)
data$EdHumanResources <- ifelse(data$EducationField == "Human Resources",1,0)
data$EdLifeSciences <- ifelse(data$EducationField == "Life Sciences",1,0)
data$EdMedical <- ifelse(data$EducationField == "Medical",1,0)
data$EdMarketing <- ifelse(data$EducationField == "Marketing",1,0)
data$EdTechnicalDegree <- ifelse(data$EducationField == "Technical Degree",1,0)
data$EdOther <- ifelse(data$EducationField == "Other",1,0)
data$JobSalesExecutive <- ifelse(data$JobRole == "Sales Executive",1,0)
data$JobResearchDirector <- ifelse(data$JobRole == "Research Director",1,0)
data$JobManufacturingDirector <- ifelse(data$JobRole == "Manufacturing Director",1,0)
data$JobResearchScientist <- ifelse(data$JobRole == "Research Scientist",1,0)
data$JobSalesExecutive <- ifelse(data$JobRole == "Sales Executive",1,0)
data$JobSalesRepresentative <- ifelse(data$JobRole == "Sales Representative",1,0)
data$JobManager <- ifelse(data$JobRole == "Manager",1,0)
data$JobHealthcareRepresentative <- ifelse(data$JobRole == "Healthcare Representative",1,0)
data$JobHumanResources <- ifelse(data$JobRole == "Human Resources",1,0)
data$JobLaboratoryTechnician <- ifelse(data$JobRole == "Laboratory Technician",1,0)

# zScale variables
data$zMonthlyIncome <- scale(data$MonthlyIncome)
data$zBusinessTravel <- scale(data$BusinessTravel)
data$zJobSatisfaction <- scale(data$JobSatisfaction)
data$zJobInvolvement <- scale(data$JobInvolvement)
data$zYearsAtCompany <- scale(data$YearsAtCompany)
data$zJobLevel <- scale(data$JobLevel)
data$zAge <- scale(data$Age)
data$zYearsInCurrentRole <- scale(data$YearsInCurrentRole)
data$zDistanceFromHome <- scale(data$DistanceFromHome)

# binary encode ordinal variables
data$LessThan5k <- ifelse(data$MonthlyIncome < 5000, 1, 0)
data$NewWorker <- ifelse(data$NumCompaniesWorked <=1, 1, 0)
data$LowLevel <- ifelse(data$JobLevel == 1, 1, 0)
data$NewHire <- ifelse(data$YearsAtCompany <4, 1, 0)
data$WorkedOver30 <- ifelse(data$TotalWorkingYears >=30, 1, 0)
data$Uninvolved <- ifelse(data$JobInvolvement <2, 1, 0)
data$NewToRole <- ifelse(data$YearsInCurrentRole <=1, 1, 0)
data$Unbalanced <- ifelse(data$WorkLifeBalance <2, 1, 0)
data$SalaryHike <- ifelse(data$PercentSalaryHike  >20, 1, 0)
data$HighlySatisfied <- ifelse(data$JobSatisfaction < 4, 0 , 1)
data$LongCommute <- ifelse(data$DistanceFromHome >= 15, 1 ,0)
data$AgeUnder40 <- ifelse(data$Age <40, 1,0)
data$DueForPromotion <- ifelse(data$YearsSinceLastPromotion %in% c(1,5,6,7), 0, 1)
data$TopPerformer <- ifelse(data$PerformanceRating < 4, 0 , 1)
data$NoStock <- ifelse(data$StockOptionLevel < 1, 1 , 0)
data$NoTraining <- ifelse(data$TrainingTimesLastYear < 1, 1 , 0)
data$HourlyOver40 <- ifelse(data$HourlyRate > 40, 1 , 0)
data$MonthlyOver15k <- ifelse(data$MonthlyRate > 15000, 1 , 0)
data$LogIncome <- log(data$MonthlyIncome)

# drop factors for regression analysis
rdata <- subset(data, select = -c(Over18, Department, JobRole, MaritalStatus, EducationField, EmployeeCount, StandardHours))

# scale numerics 0-1 to improve KNN performance
kdata <- data.frame(apply(rdata, MARGIN = 2, FUN = function(X) (X - min(X))/diff(range(X))))

```

```{r visualize}
data %>% group_by(Attrition) %>% summarise(Employees = n()) %>% ggplot(mapping=aes(Attrition, Employees)) + geom_col()


data %>% select('BusinessTravel','JobSatisfaction','MonthlyIncome','OverTime','JobInvolvement','TotalWorkingYears','JobLevel','DistanceFromHome',"Gender", 'Attrition') %>% ggpairs()

data %>% select("EducationField",'HighlySatisfied','OverTime','LowLevel','Unbalanced', "JobRole", "WorkedOver30",'MaritalStatus','JobInvolvement',"SalaryHike", "NewHire","NewWorker","NewToRole", "AgeUnder40","DueForPromotion","TopPerformer","NoStock","Gender","Attrition") %>% ggpairs()


data %>% select("EducationField",'HighlySatisfied','OverTime','LowLevel','Unbalanced', "JobRole", "WorkedOver30",'JobInvolvement',"SalaryHike", "NewHire","NewWorker","NewToRole", "AgeUnder40","DueForPromotion","TopPerformer","NoStock","Attrition") %>% ggpairs()

data %>% ggplot(aes(JobSatisfaction, Attrition)) + geom_smooth()
data %>% ggplot(aes(TrainingTimesLastYear, Attrition)) + geom_smooth()
data %>% ggplot(aes(Education, Attrition)) + geom_smooth()

data %>% ggplot(aes(JobLevel, Attrition)) + geom_smooth()
data %>% ggplot(aes(BusinessTravel, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsInCurrentRole, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsAtCompany, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsSinceLastPromotion, Attrition)) + geom_smooth()
data %>% ggplot(aes(YearsWithCurrManager, Attrition)) + geom_smooth()
data %>% ggplot(aes(TotalWorkingYears, Attrition)) + geom_smooth()
data %>% ggplot(aes(MonthlyIncome, Attrition)) + geom_smooth()
data %>% ggplot(aes(JobLevel, Attrition)) + geom_smooth()
data %>% ggplot(aes(JobSatisfaction, Attrition)) + geom_smooth()
data %>% ggplot(aes(RelationshipSatisfaction, Attrition)) + geom_smooth()
data %>% ggplot(aes(DistanceFromHome, Attrition)) + geom_smooth()
data %>% ggplot(aes(DailyRate, Attrition)) + geom_smooth()
data %>% ggplot(aes(HourlyRate, Attrition)) + geom_smooth()
data %>% ggplot(aes(MonthlyRate, Attrition)) + geom_smooth()

unique(data$DailyRate)
unique(data$HourlyRate)
unique(data$MonthlyRate)

data %>% ggplot(aes(JobInvolvement, Attrition)) + geom_smooth()
data %>% ggplot(aes(WorkLifeBalance, Attrition)) + geom_smooth()
data %>% ggplot(aes(PercentSalaryHike, Attrition)) + geom_smooth()
data %>% ggplot(aes(Age, Attrition)) + geom_smooth()
oData %>% ggplot(aes(PerformanceRating, fill=Attrition)) + geom_bar()
data %>% ggplot(aes(StockOptionLevel, Attrition)) + geom_smooth()

oData %>% ggplot(aes(NumCompaniesWorked, fill=Attrition)) + geom_bar()
oData %>% ggplot(aes(Department, fill=Attrition)) + geom_bar()

oData %>% ggplot(aes(JobRole)) + geom_bar(aes(fill=Attrition))
data %>% ggplot(aes(JobResearchDirector, Attrition)) + geom_col()
data %>% ggplot(aes(JobSalesExecutive, Attrition)) + geom_col()
data %>% ggplot(aes(JobManufacturingDirector, Attrition)) + geom_col()
data %>% ggplot(aes(JobResearchScientist, Attrition)) + geom_col()
data %>% ggplot(aes(JobHumanResources, Attrition)) + geom_col()
data %>% ggplot(aes(JobHealthcareRepresentative, Attrition)) + geom_col()
data %>% ggplot(aes(JobManager, Attrition)) + geom_col()
data %>% ggplot(aes(JobSalesRepresentative, Attrition)) + geom_col()
data %>% ggplot(aes(JobLaboratoryTechnician, Attrition)) + geom_col()

oData %>% ggplot(aes(EducationField)) + geom_bar(aes(fill=Attrition))
data %>% ggplot(aes(EdHumanResources, Attrition)) + geom_col()
data %>% ggplot(aes(EdMedical, Attrition)) + geom_col()
data %>% ggplot(aes(EdMarketing, Attrition)) + geom_col()
data %>% ggplot(aes(EdTechnicalDegree, Attrition)) + geom_col()
data %>% ggplot(aes(EdOther, Attrition)) + geom_col()
data %>% ggplot(aes(EdLifeSciences, Attrition)) + geom_col()

oData %>% ggplot(aes(MaritalStatus)) + geom_bar(aes(fill=Attrition))
data %>% ggplot(aes(Single, Attrition)) + geom_col()
data %>% ggplot(aes(Married, Attrition)) + geom_col()
data %>% ggplot(aes(Divorced, Attrition)) + geom_col()
oData %>% ggplot(aes(Gender, fill=Attrition)) + geom_bar()



oData %>% ggplot(aes(OverTime, fill=Attrition)) + geom_bar()
data %>% ggplot(aes(OverTime, JobSatisfaction)) + geom_smooth()

```


```{r view correlation}
data.cor <- cor(rdata)
data.cor %>% kable("html") %>% kable_styling

# mat : is a matrix of data
# ... : further arguments to pass to the native R cor.test function
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
# matrix of the p-value of the correlation
p.mat <- cor.mtest(rdata)

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
png(height=1200, width=1500, pointsize=8, file="corrNums.png")
corrplot(data.cor, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.01, insig = "blank", tl.cex = 1.25,
         # hide correlation coefficient on the principal diagonal
         diag=FALSE 
         )
ggsave("corrNums.png", units="in", width=5, height=4, dpi=600)
dev.off()

png(height=1200, width=1800, pointsize=15, file="overlap.png")
corrplot(data.cor, method='circle', order="hclust",tl.col="black", type='upper', tl.cex = 1, p.mat = p.mat, sig.level = 0.01, insig = 'blank')
ggsave("corrHalf.png", units="in", width=5, height=4, dpi=600)
dev.off()

png(height=1200, width=1500, pointsize=10, file="corrMixed.png")
corrplot.mixed(data.cor, number.cex = .6, tl.cex = 1, tl.pos = 'lt',tl.col="black")
ggsave("corrMixed.png", units="in", width=5, height=4, dpi=600)
dev.off()
```


# KNN Prediction
```{r KNN attrition}

iterations = 50
set.seed(5)
numks = round(sqrt(dim(kdata)[1]))
masterAcc = matrix(nrow = iterations, ncol = numks)
masterSpec = matrix(nrow = iterations)
masterSen = matrix(nrow = iterations)
knnArray <- c('BusinessTravel','JobSatisfaction','MonthlyIncome','OverTime','JobInvolvement','TotalWorkingYears','JobLevel','DistanceFromHome',"Gender")
knnArray <- c('JobSatisfaction','OverTime','WorkLifeBalance','JobInvolvement','NewHire','YearsSinceLastPromotion','NoStock','DistanceFromHome')

#knnArray <- c('JobSatisfaction','OverTime','JobLevel','WorkLifeBalance', 'JobInvolvement',"PercentSalaryHike",
            #  "YearsAtCompany","YearsInCurrentRole","TotalWorkingYears","Age","YearsSinceLastPromotion","PerformanceRating","StockOptionLevel",
          #    'BusinessTravel',"Gender",'JobSatisfaction')

for(j in 1:iterations) {
  
  accs = data.frame(accuracy = numeric(numks), k = numeric(numks))
  trainIndices = sample(1:dim(kdata)[1],round(splitPerc * dim(kdata)[1]))
  train = kdata[trainIndices,]
  test = kdata[-trainIndices,]
  
  for(i in 1:numks) {
    
    classifications = knn(train[,knnArray],test[,knnArray],as.factor(train$Attrition), prob = TRUE, k = i)
    
    table(as.factor(test$Attrition),classifications)
    CM = confusionMatrix(table(as.factor(test$Attrition),classifications))
    masterAcc[j,i] = CM$overall[1]
    masterSen[j] = CM$byClass[1]
    masterSpec[j] = ifelse(is.na(CM$byClass[2]),0,CM$byClass[2])

  }
}

MeanAcc = colMeans(masterAcc)
plot(seq(1,numks,1),MeanAcc, Attrition = 1)
k <- which.max(MeanAcc)
MeanAcc[k]

classifications = knn(train[,knnArray],test[,knnArray],as.factor(train$Attrition), prob = TRUE, k = k)
confusionMatrix(table(test$Attrition,classifications))


```

# Naive Bayes for Attrition

```{r Naive Bayes attrition}

iterations = 100
set.seed(7)
masterAcc = matrix(nrow = iterations)
masterSpec = matrix(nrow = iterations)
masterSen = matrix(nrow = iterations)

nbArray <- c('HighlySatisfied','OverTime','LowLevel','Unbalanced',"WorkedOver30",'JobInvolvement',"SalaryHike", "NewHire","NewToRole", "AgeUnder40","DueForPromotion","TopPerformer","NoStock","MaritalStatus","LogIncome","MonthlyOver15k","HourlyOver40")
model = naiveBayes(train[,nbArray],as.factor(train$Attrition),laplace = .0001)
confusionMatrix(table(predict(model,test[,nbArray]),as.factor(test$Attrition)))


for(j in 1:iterations)
{
  
  trainIndices = sample(1:dim(data)[1],round(splitPerc * dim(data)[1]))
  train = data[trainIndices,]
  test = data[-trainIndices,]
  model = naiveBayes(train[,nbArray],as.factor(train$Attrition),laplace = .0001)
  CM = confusionMatrix(table(predict(model,test[,nbArray]),as.factor(test$Attrition)))
  masterAcc[j] = CM$overall[1]
  masterSen[j] = CM$byClass[1]
  masterSpec[j] = CM$byClass[2]

}
colMeans(masterAcc)
colMeans(masterSen)
colMeans(masterSpec)

confusionMatrix(table(predict(model,test[,nbArray]),as.factor(test$Attrition)))


```

# Fast Naive Bayes for Attrition

```{r Fast Naive Bayes attrition}

iterations = 100
set.seed(7)
masterAcc2 = matrix(nrow = iterations)
masterSpec2 = matrix(nrow = iterations)
masterSen2 = matrix(nrow = iterations)
splitPerc = .7 #Training / Test split Percentage

nbArray2 <- c('OverTime', 'LowLevel','HighlySatisfied','Unbalanced',"WorkedOver30","SalaryHike", "NewHire","NewToRole", "AgeUnder40","DueForPromotion","TopPerformer","NoStock","Gender","Uninvolved", 'Single','Divorced','Married',"LongCommute","NoTraining","HourlyOver40","MonthlyOver15k","JobManager","JobSalesExecutive", 'JobSalesRepresentative')

model2 = fnb.bernoulli(train2[,nbArray2], train2$Attrition, laplace = .0001)

confusionMatrix(table(predict(model2,test2[,nbArray2]),as.factor(test2$Attrition)))

for(j in 1:iterations)
{
  
  trainIndices = sample(1:dim(data)[1],round(splitPerc * dim(data)[1]))
  train2 = rdata[trainIndices,]
  test2 = rdata[-trainIndices,]
  model2 = fnb.bernoulli(train2[,nbArray2], train2$Attrition, laplace = .0001)
  table(predict(model2,test2[,nbArray2]),as.factor(test2$Attrition))  
  
  CM2 = confusionMatrix(table(predict(model2,test2[,nbArray2]),as.factor(test2$Attrition)))
  masterAcc2[j] = CM2$overall[1]
  masterSen2[j] = CM2$byClass[1]
  masterSpec2[j] = CM2$byClass[2]
}
colMeans(masterAcc2)
colMeans(masterSen2)
colMeans(masterSpec2)

confusionMatrix(table(predict(model2,test2[,nbArray2]),as.factor(test2$Attrition)))


```


# Logistic Regression
```{r logistic regression}

model3 <- glm(Attrition ~ JobSatisfaction+ OverTime+ WorkLifeBalance+ JobInvolvement + NewHire + YearsSinceLastPromotion+NoStock+DistanceFromHome+BusinessTravel +EnvironmentSatisfaction + JobRole,  data=train, family="binomial")

#model3 <- glm(Attrition ~ JobRole ,data=train, family="binomial")

#HourlyRate+NewToRole +NumCompaniesWorked+LogIncome+JobRole
summary(model3)
atPrd <- predict(model3, type='response', newdata = test)
actualPred <- ifelse(atPrd > 0.5, 1, 0)
confusionMatrix(table(as.factor(actualPred), as.factor(test2$Attrition)))

#actualPred %>% kable("html") %>% kable_styling()
#atPrd

#RMSE <- sqrt(mean((atPrd[,1] - test$Attrition)^2))
#RMSE

```

# Regression for Salary

```{r salary regression}


train$LogMonthlyIncome <- log(train$MonthlyIncome)
  trainIndices = sample(1:dim(rdata)[1],round(splitPerc * dim(rdata)[1]))
  train = rdata[trainIndices,]
  test = rdata[-trainIndices,]
salFit <- lm(MonthlyIncome ~ JobLevel + TotalWorkingYears
             + JobManager + JobResearchDirector + JobLaboratoryTechnician 
             , data=train)
summary(salFit)

salPrd <- predict(salFit, interval='predict',newdata = test)
RMSE <- sqrt(mean((salPrd[,1] - test$MonthlyIncome)^2))
RMSE

olsrr::ols_plot_diagnostics(salFit)

```
